name: Flutter CI

# This workflow is triggered on pushes to the repository.

on:
  pull_request:
    branches:
    - dev
    
  workflow_dispatch:
    
# on: push    # Default will running for every branch.
    
jobs:
  build:
    # This job will run on ubuntu virtual machine
    runs-on: ubuntu-latest
    steps:
    
    - uses: actions/checkout@v3
    
    # Setup the flutter environment.
    - uses: subosito/flutter-action@v2
    
    - name: Run CI for all packages
      run: |
        # Check formatting for the entire repository
        echo "ðŸ§ Checking formatting..."
        dart format --set-exit-if-changed .

        # Find all directories with pubspec.yaml (excluding .dart_tool and build)
        packages=$(find . -maxdepth 4 -name "pubspec.yaml" | grep -v "/.dart_tool/" | grep -v "/build/" | sed 's/\/pubspec.yaml//' | sort)

        for pkg in $packages; do
          echo ""
          echo "----------------------------------------------------"
          echo "ðŸš€ Processing $pkg"
          echo "----------------------------------------------------"
          
          # Navigate into package directory
          cd "$pkg"
          
          # Get dependencies
          flutter pub get
          
          # Statically analyze the Dart code
          echo "ðŸ“ Analyzing $pkg..."
          dart analyze .
          
          # Run tests if test directory exists
          if [ -d "test" ]; then
            echo "ðŸ§ª Running tests for $pkg..."
            flutter test
          else
            echo "â„¹ï¸ No tests found in $pkg"
          fi
          
          # Navigate back to root
          cd - > /dev/null
        done
